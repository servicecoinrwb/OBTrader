<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ultimate Guide to Oracle-Based Trading</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Georgia, 'Times New Roman', Times, serif;
            line-height: 1.7;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 3rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            margin-bottom: 2rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #00d2ff;
            text-decoration: none;
            padding: 0.8rem 1.5rem;
            background: rgba(0, 210, 255, 0.1);
            border-radius: 25px;
            border: 1px solid rgba(0, 210, 255, 0.2);
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .back-link:hover {
            background: rgba(0, 210, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 210, 255, 0.2);
        }
        
        .header {
            text-align: center;
            padding: 2rem 0 3rem 0;
            border-bottom: 2px solid rgba(0, 210, 255, 0.3);
            margin-bottom: 3rem;
            position: relative;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 1.5rem;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            position: relative;
        }
        
        .hexagon {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: center;
            animation: rotate 20s linear infinite;
        }
        
        .hexagon:nth-child(1) {
            animation-delay: 0s;
            opacity: 0.8;
        }
        
        .hexagon:nth-child(2) {
            animation-delay: -10s;
            opacity: 0.6;
        }
        
        .center-node {
            position: absolute;
            width: 16px;
            height: 16px;
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.5);
            animation: pulse 2s ease-in-out infinite alternate;
        }
        
        .brand-name {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00d2ff, #3a7bd5, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.5px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        h1 {
            color: #ffffff;
            font-size: 3.2rem;
            margin: 0;
            font-weight: 700;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
            background: linear-gradient(135deg, #ffffff, rgba(255, 255, 255, 0.8));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        h2 {
            color: #00d2ff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            border-bottom: 2px solid #00d2ff;
            padding-bottom: 15px;
            margin-top: 4rem;
            margin-bottom: 2rem;
            font-size: 2.2rem;
            font-weight: 600;
            text-shadow: 0 0 20px rgba(0, 210, 255, 0.3);
        }
        
        h3 {
            color: #00ff88;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 1.6rem;
            margin-top: 3rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        
        h4 {
            color: #3a7bd5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 1.3rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        p, li {
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 1rem;
            font-size: 1.05rem;
        }
        
        strong {
            color: #ffffff;
            font-weight: 700;
        }
        
        a {
            color: #00d2ff;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        a:hover {
            color: #00ff88;
            text-decoration: underline;
        }
        
        code {
            background: rgba(0, 210, 255, 0.1);
            padding: 0.3em 0.6em;
            border-radius: 6px;
            font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
            color: #00ff88;
            border: 1px solid rgba(0, 210, 255, 0.2);
            font-size: 0.9em;
        }
        
        .case-study, .checklist {
            background: rgba(0, 210, 255, 0.05);
            border-left: 4px solid #00d2ff;
            padding: 2rem;
            margin: 2.5rem 0;
            border-radius: 12px;
            border: 1px solid rgba(0, 210, 255, 0.2);
            backdrop-filter: blur(5px);
        }
        
        .case-study h4, .checklist h4 {
            margin-top: 0;
            color: #00d2ff;
            text-shadow: 0 0 15px rgba(0, 210, 255, 0.3);
        }
        
        .checklist ul {
            list-style: none;
            padding-left: 0;
        }
        
        .checklist li {
            position: relative;
            padding-left: 2rem;
            margin: 1rem 0;
        }
        
        .checklist li::before {
            content: '✅';
            position: absolute;
            left: 0;
            top: 0;
        }
        
        ol, ul {
            padding-left: 2rem;
            margin: 1.5rem 0;
        }
        
        li {
            margin: 0.8rem 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        th, td {
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
        }
        
        th {
            background: rgba(0, 210, 255, 0.1);
            color: #00d2ff;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        td {
            color: rgba(255, 255, 255, 0.85);
        }
        
        hr {
            border: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(0, 210, 255, 0.5), transparent);
            margin: 4rem 0;
        }
        
        .download-link {
            display: inline-block;
            margin-top: 1.5rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            color: #fff;
            text-decoration: none;
            border-radius: 25px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(0, 210, 255, 0.2);
        }
        
        .download-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 210, 255, 0.3);
            color: #fff;
        }

        /* Trading Simulator Styles */
        #trading-simulator-app {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: rgba(0, 0, 0, 0.2);
            color: #EAEAEA;
            padding: 2rem;
            border-radius: 15px;
            margin: 3rem 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            --bg-color: #121212;
            --container-bg: rgba(30, 30, 30, 0.8);
            --border-color: rgba(255, 255, 255, 0.2);
            --text-color: #EAEAEA;
            --text-soft-color: #B0B0B0;
            --bitcoin-orange: #f7931a;
            --price-green: #00ff88;
            --price-red: #ef5350;
            --highlight-blue: #00d2ff;
            --warn-yellow: #fdd835;
        }

        #trading-simulator-app #container {
            background-color: var(--container-bg);
            border-radius: 15px;
            padding: 2rem;
            max-width: 100%;
            width: 100%;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        #trading-simulator-app #scenario-info {
            background: rgba(0, 210, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
            border: 1px solid rgba(0, 210, 255, 0.2);
        }
        
        #trading-simulator-app #scenario-info h3 { 
            margin: 0 0 0.5rem 0; 
            color: var(--highlight-blue); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            font-size: 1.4rem;
        }
        
        #trading-simulator-app #scenario-info p { 
            margin: 0; 
            font-size: 1rem; 
            color: var(--text-soft-color); 
        }
        
        #trading-simulator-app #chart-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        #trading-simulator-app .chart-overlay-display {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            display: none;
            z-index: 10;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #trading-simulator-app #pl-display { top: 15px; left: 15px; }
        #trading-simulator-app #rr-display { top: 15px; right: 15px; }
        #trading-simulator-app .rr-good { color: var(--price-green); }
        #trading-simulator-app .rr-ok { color: var(--warn-yellow); }
        #trading-simulator-app .rr-bad { color: var(--price-red); }
        
        #trading-simulator-app #chart-svg { width: 100%; height: 300px; }

        #trading-simulator-app .candlestick.up { fill: var(--price-green); stroke: var(--price-green); }
        #trading-simulator-app .candlestick.down { fill: var(--price-red); stroke: var(--price-red); }
        #trading-simulator-app .wick { stroke-width: 1; }
        #trading-simulator-app .price-axis text { font-size: 10px; fill: var(--text-soft-color); }
        #trading-simulator-app .grid-line { stroke: rgba(255, 255, 255, 0.1); stroke-width: 1; }

        #trading-simulator-app .price-line { stroke-width: 2; stroke-dasharray: 4; cursor: ns-resize; opacity: 0.8; }
        #trading-simulator-app #sl-line { stroke: var(--price-red); }
        #trading-simulator-app #tp-line { stroke: var(--price-green); }
        #trading-simulator-app #limit-line { stroke: var(--highlight-blue); }

        #trading-simulator-app .price-label { font-size: 10px; font-weight: bold; pointer-events: none; }
        #trading-simulator-app #sl-label { fill: var(--price-red); }
        #trading-simulator-app #tp-label { fill: var(--price-green); }
        #trading-simulator-app #limit-label { fill: var(--highlight-blue); }

        #trading-simulator-app h1, #trading-simulator-app h2 { 
            text-align: center; 
            color: #FFFFFF; 
            padding-bottom: 15px; 
            margin-top: 0; 
            margin-bottom: 20px; 
            border-bottom: none; 
        }

        #trading-simulator-app .controls-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
            align-items: center; 
        }

        #trading-simulator-app button {
            padding: 12px 24px; 
            font-size: 16px; 
            font-weight: 600;
            border-radius: 12px; 
            border: none; 
            cursor: pointer;
            transition: all 0.3s ease; 
            color: white;
        }
        
        #trading-simulator-app button:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); 
        }
        
        #trading-simulator-app button:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }

        #trading-simulator-app #order-type-selector {
            grid-column: 1 / -1; 
            display: flex;
            background: rgba(255, 255, 255, 0.05); 
            border-radius: 12px; 
            padding: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #trading-simulator-app .order-type-btn { 
            flex: 1; 
            padding: 12px; 
            background: transparent;
            border-radius: 8px;
        }
        
        #trading-simulator-app .order-type-btn.active { 
            background: var(--highlight-blue); 
            box-shadow: 0 4px 12px rgba(0, 210, 255, 0.3); 
        }

        #trading-simulator-app #long-button { background: var(--price-green); }
        #trading-simulator-app #short-button { background: var(--price-red); }
        #trading-simulator-app #confirm-button { background: var(--highlight-blue); grid-column: 1 / span 1; }
        #trading-simulator-app #cancel-button { background: #616161; grid-column: 2 / span 1; }
        #trading-simulator-app #reset-button { background: #616161; grid-column: 1 / -1; }
        #trading-simulator-app #close-button { background: var(--bitcoin-orange); grid-column: 1 / -1;}
        
        #trading-simulator-app .section-box {
            background: rgba(255, 255, 255, 0.03); 
            border-radius: 15px;
            padding: 2rem; 
            margin-top: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #trading-simulator-app .calc-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 1.5rem; 
        }
        
        #trading-simulator-app .calc-item { 
            display: flex; 
            flex-direction: column; 
        }
        
        #trading-simulator-app .calc-item label { 
            font-size: 0.85em; 
            color: var(--text-soft-color); 
            margin-bottom: 8px; 
            font-weight: 500;
        }
        
        #trading-simulator-app .calc-item .value { 
            font-size: 1.3em; 
            font-weight: 700; 
        }
        
        #trading-simulator-app #position-size {
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            color: white;
            padding: 12px; 
            border-radius: 8px; 
            font-size: 1.1em; 
            width: 100%;
        }
        
        #trading-simulator-app #leverage-slider { 
            width: 100%; 
            cursor: pointer;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            appearance: none;
        }
        
        #trading-simulator-app #leverage-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--highlight-blue);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 210, 255, 0.5);
        }
        
        #trading-simulator-app #result-feedback {
            display: none; 
            padding: 2rem; 
            margin-top: 2rem;
            border-radius: 15px; 
            text-align: center;
            font-size: 1.5em; 
            font-weight: 700;
        }
        
        #trading-simulator-app .win { 
            background: rgba(0, 255, 136, 0.1); 
            border: 2px solid var(--price-green); 
            color: var(--price-green); 
        }
        
        #trading-simulator-app .loss { 
            background: rgba(239, 83, 80, 0.1); 
            border: 2px solid var(--price-red); 
            color: var(--price-red); 
        }
        
        #trading-simulator-app .draw { 
            background: rgba(189, 189, 189, 0.1); 
            border: 2px solid #BDBDBD; 
            color: #BDBDBD; 
        }

        #trading-simulator-app #performance-stats .calc-item .value { font-size: 1.2em; }
        
        #trading-simulator-app #history-log { max-height: 250px; overflow-y: auto; }
        #trading-simulator-app #history-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.9em; 
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }
        
        #trading-simulator-app #history-table th, 
        #trading-simulator-app #history-table td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid var(--border-color); 
        }
        
        #trading-simulator-app #history-table th { 
            font-size: 0.85em; 
            color: var(--highlight-blue); 
            background: rgba(0, 210, 255, 0.1);
            font-weight: 600;
        }
        
        #trading-simulator-app #equity-curve-svg { 
            width: 100%; 
            height: 120px; 
            margin-top: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        #trading-simulator-app #equity-curve-path { 
            stroke: var(--highlight-blue); 
            stroke-width: 2; 
            fill: none; 
        }
        
        #trading-simulator-app #equity-curve-zero-line { 
            stroke: var(--border-color); 
            stroke-width: 1; 
            stroke-dasharray: 4;
        }
        
        /* Animations */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            from { transform: translate(-50%, -50%) scale(1); }
            to { transform: translate(-50%, -50%) scale(1.2); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                margin: 1rem;
                padding: 2rem;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            h2 {
                font-size: 1.8rem;
            }
            
            h3 {
                font-size: 1.4rem;
            }
            
            .logo-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .brand-name {
                font-size: 1rem;
            }
            
            #trading-simulator-app .calc-grid {
                grid-template-columns: 1fr;
            }
            
            #trading-simulator-app .controls-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 210, 255, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 210, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="container" id="course-content">
        <a href="index.html" class="back-link">← Back to Home</a>

        <div class="header">
            <div class="logo-container">
                <div class="logo-icon">
                    <svg class="hexagon" viewBox="0 0 100 100">
                        <polygon points="50,5 85,25 85,65 50,85 15,65 15,25" 
                                 fill="none" 
                                 stroke="url(#gradient1)" 
                                 stroke-width="2"/>
                        <defs>
                            <linearGradient id="gradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#00d2ff"/>
                                <stop offset="100%" style="stop-color:#3a7bd5"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    
                    <svg class="hexagon" viewBox="0 0 100 100">
                        <polygon points="50,15 75,30 75,60 50,75 25,60 25,30" 
                                 fill="none" 
                                 stroke="url(#gradient2)" 
                                 stroke-width="1.5"/>
                        <defs>
                            <linearGradient id="gradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#00ff88"/>
                                <stop offset="100%" style="stop-color:#00d2ff"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    
                    <div class="center-node"></div>
                </div>
                <h2 class="brand-name">DECENTRALIZED EDGE</h2>
            </div>
            <h1>The Ultimate Guide to Oracle-Based Trading</h1>
        </div>

        <h2>Chapter 1: The Foundations of Oracle Trading</h2>
        <p>At its heart, a smart contract on a blockchain is isolated; it can't access outside information like the current price of Bitcoin. This is known as the <strong>"Oracle Problem."</strong> An oracle acts as a secure bridge, solving this problem by feeding real-world data to the smart contract.</p>
        <p>Here's the process on a platform like Gains Network (gTrade):</p>
        <ol>
            <li><strong>Price Feeds:</strong> Decentralized Oracle Networks (DONs) like Chainlink gather price data from many sources to create a single, manipulation-resistant price point.</li>
            <li><strong>Opening a Trade:</strong> When you open a position, the smart contract requests the current price from the oracle. This becomes your <strong>entry price</strong>.</li>
            <li><strong>The Position:</strong> Your trade is a <em>synthetic</em> position recorded in the smart contract. You don't actually own the underlying asset.</li>
            <li><strong>Closing a Trade:</strong> When you close your position, the smart contract again pings the oracle for the current price. This is your <strong>exit price</strong>.</li>
            <li><strong>Profit and Loss (P&L) Calculation:</strong> The contract calculates your profit or loss on-chain using the formula: <code>P&L = (Exit Price - Entry Price) × Position Size</code>.</li>
            <li><strong>Liquidation:</strong> If the price moves against you and your losses approach your collateral value, the smart contract automatically closes your position.</li>
        </ol>
        <div class="case-study">
            <h4>Case Study: The Importance of Decentralized Oracles</h4>
            <p>In 2020, several DeFi protocols experienced exploits because they relied on a single, centralized price source. A flash loan attack manipulated the price on that one source, causing the protocol's smart contract to approve faulty liquidations and trades, leading to millions in losses. This highlights why robust, decentralized oracles that aggregate many sources are non-negotiable for security.</p>
        </div>
        
        <hr>

        <h2>Chapter 2: Your Trading Roadmap</h2>
        <h3>Step 1: Master the Fundamentals</h3>
        <p>Before placing a trade, understand the environment. Read the documentation for <strong><a href="https://docs.chain.link/data-feeds" target="_blank" rel="noopener noreferrer">Chainlink Data Feeds</a></strong> and the specific platform you intend to use, like <strong><a href="https://gains.trade/" target="_blank" rel="noopener noreferrer">Gains Network (gTrade)</a></strong>. A deep understanding of leverage, fees, and funding rates is critical.</p>
        
        <h3>Step 2: Develop a Trading Strategy</h3>
        <p>A strategy is your rulebook. Learn <strong><a href="https://www.investopedia.com/terms/t/technicalanalysis.asp" target="_blank" rel="noopener noreferrer">Technical Analysis (TA)</a></strong> concepts like market structure, support/resistance, and indicators. Most importantly, define your <strong>Risk Management</strong> rules: position sizing, using a <strong>Stop-Loss (SL)</strong>, and setting a <strong>Take-Profit (TP)</strong>.</p>

        <h3>Step 3: Practice Without Risk</h3>
        <p>Use paper trading features on platforms like <strong><a href="https://www.tradingview.com/" target="_blank" rel="noopener noreferrer">TradingView</a></strong> to test your strategy with fake money. Keep a detailed trading journal of every trade to analyze your performance and refine your rules.</p>

        <h3>Step 4: Go Live, But Start Small</h3>
        <p>Once you are consistently profitable on paper, you can trade with real, but minimal, capital. Start with low leverage (2x-5x) to get a feel for the market and continue journaling every trade.</p>

        <hr>

        <h2>Chapter 3: Advanced Market Concepts</h2>
        <h3>Oracle Price vs. Mark Price vs. Index Price</h3>
        <ul>
            <li><strong>Oracle/Index Price:</strong> The aggregated, true price of the asset. This is the price used for final <strong>settlement and liquidation</strong>.</li>
            <li><strong>Mark Price:</strong> The price used to calculate your unrealized (floating) P&L. It's designed to be smoother than the Oracle Price to prevent unfair liquidations from short-term volatility.</li>
        </ul>
        
        <h3>Open Interest (OI)</h3>
        <p>Open Interest is the total value of all outstanding synthetic positions. It's a critical measure of market activity and conviction.</p>
        <ul>
            <li><strong>Trend Confirmation:</strong> Rising price + Rising OI = Strong trend.</li>
            <li><strong>Trend Weakness:</strong> Rising price + Falling OI = Trend may be losing momentum.</li>
        </ul>

        <h3>Skew and the Funding Rate</h3>
        <p>The funding rate is a fee exchanged between long and short traders to keep the synthetic price pegged to the real asset price. It's determined by the <strong>skew</strong>, or the imbalance between longs and shorts.</p>
        <ul>
            <li><strong>Positive Skew (More Longs):</strong> Longs pay shorts. The funding rate is positive.</li>
            <li><strong>Negative Skew (More Shorts):</strong> Shorts pay longs. The funding rate is negative.</li>
        </ul>
        <p>The funding rate is a powerful tool for gauging market sentiment. An extremely high rate suggests the market is over-leveraged and may be due for a correction.</p>
        
        <hr>

        <h2>Chapter 4: Practical Trading Strategies</h2>
        <h3>Strategy 1: The Skew & Funding Rate Fade (Contrarian)</h3>
        <p>This is a contrarian strategy that aims to profit from "fading" or betting against overcrowded trades when market sentiment reaches an extreme. The core idea is that when almost everyone is on one side of the market (high skew) and paying high funding rates to maintain their positions, the market becomes vulnerable to a sharp reversal or "squeeze."</p>
        <p>When funding rates are extremely high and positive, it means longs are heavily crowded and paying a significant premium. These leveraged long positions provide the "fuel" for a sharp move down. A small price drop can trigger a cascade of liquidations, forcing longs to sell, which pushes the price down further, liquidating even more longs. This strategy aims to anticipate and profit from this cascade.</p>
        <div class="case-study">
            <h4>Execution Plan: Fading the Longs</h4>
            <ol>
                <li><strong>Patience is Key:</strong> Wait for a sustained period of very high positive funding.</li>
                <li><strong>Entry:</strong> Enter a <strong>short</strong> position once the price shows signs of rejecting a key resistance level.</li>
                <li><strong>Stop-Loss:</strong> Place a strict stop-loss just above the resistance.</li>
                <li><strong>Take-Profit:</strong> Set targets at key support levels below.</li>
            </ol>
        </div>

        <h3>Strategy 2: The Trend Following Breakout (Momentum)</h3>
        <p>This strategy is the opposite of fading. Instead of betting against the crowd, you bet *with* them when strong momentum is confirmed. This is for traders who believe "the trend is your friend."</p>
        <p>The idea is to identify a strong, established trend and enter when the price breaks through a key level, anticipating that the momentum will continue. Here, the metrics we've discussed are used for confirmation, not as contrarian signals.</p>
        <div class="case-study">
            <h4>Execution Plan: Trading a Breakout</h4>
            <ol>
                <li><strong>Identify the Trend:</strong> Look for a clear uptrend (higher highs and higher lows).</li>
                <li><strong>Confirmation Signals:</strong> As the price approaches a key resistance level, you want to see <strong>Open Interest rising</strong>. This shows new money is entering to support the move, not just shorts closing. A moderately positive funding rate is acceptable.</li>
                <li><strong>Entry:</strong> Enter a <strong>long</strong> position *after* the price has decisively broken through and closed above the resistance level.</li>
                <li><strong>Stop-Loss:</strong> Place a stop-loss just below the resistance level that was broken.</li>
                <li><strong>Take-Profit:</strong> Use trailing stops or set targets at the next major resistance area.</li>
            </ol>
        </div>

        <hr>

        <h2>Chapter 5: Risk Management & Platform Nuances</h2>
        <h3>How to Find High-Interest Price Zones (Like Heavy Shorts)</h3>
        <p>While you can't see the exact entry price of every trade, you can identify high-probability zones where large numbers of traders have likely placed their bets. This is done by combining technical analysis with an understanding of market psychology.</p>
        
        <h3>1. Key Technical Resistance Levels</h3>
        <p>Short-sellers don't enter randomly; they target areas where the price is likely to be rejected. These are almost always significant resistance zones on the chart.</p>
        <ul>
            <li><strong>Previous Highs & Supply Zones:</strong> The last significant peak or a consolidation area before a drop are prime spots for short entries.</li>
            <li><strong>Major Moving Averages:</strong> On higher timeframes, key moving averages (like the 50-day or 200-day) can act as powerful resistance.</li>
        </ul>

        <h3>2. The Liquidation Price Magnet</h3>
        <p>This is the most critical concept. If you know where a large cluster of shorts entered (at resistance), you also know their liquidation prices are clustered just above it.</p>
        <ul>
            <li><strong>The "Fuel":</strong> These clusters of liquidation levels act as a pool of liquidity.</li>
            <li><strong>The Magnet Effect:</strong> The market is often drawn towards these pools. A move towards the liquidation cluster can trigger a <strong>short squeeze</strong>, where the forced buying from liquidated shorts pushes the price even higher, very quickly.</li>
        </ul>

        <h3>3. Key Platform Risks</h3>
        <ul>
            <li><strong>Smart Contract Risk:</strong> Always use reputable, audited platforms. A bug in the code is a systemic risk.</li>
            <li><strong>Oracle Latency:</strong> There is a small, unavoidable delay from when a price event happens in the real world to when it's reported on-chain. This makes extremely high-frequency trading difficult.</li>
            <li><strong>Gas Fees:</strong> On congested networks, high transaction fees can eat into the profits of smaller trades.</li>
        </ul>

        <hr>

        <h2>Chapter 6: Tools for Success</h2>

        <h3>Your Pre-Flight Checklist</h3>
        <div class="checklist">
            <h4>Before Every Trade, Ask Yourself:</h4>
            <ul>
                <li><strong>Is this trade part of my strategy?</strong> (Am I following my rules or trading on emotion?)</li>
                <li><strong>What is the current market sentiment?</strong> (Have I checked the skew and funding rate?)</li>
                <li><strong>Where is my invalidation point?</strong> (Is my Stop-Loss set?)</li>
                <li><strong>Is my Risk/Reward ratio favorable?</strong> (Is my potential profit at least 2x my potential loss?)</li>
                <li><strong>What is my position size?</strong> (Am I risking more than 1-2% of my capital?)</li>
            </ul>
        </div>
        
        <h3>The Trading Journal</h3>
        <p>A trading journal is the single most effective tool for improving as a trader. It forces you to be accountable for your decisions and helps you identify your weaknesses and strengths. Religiously tracking your trades will reveal patterns in your behavior that you would otherwise miss.</p>
        <a href="https://servicecoinrwb.github.io/OBTrader/trading-journal.html" target="_blank">View the Trading Journal</a>

        <hr>
        
        <h2>Chapter 7: Trading Simulator</h2>
        <p>Theory is one thing, but practice is where lessons are truly learned. Use this interactive simulator to test the strategies you've learned in a risk-free environment. Can you apply the concepts of support, resistance, and risk management to turn a profit?</p>

        <div id="trading-simulator-app">
            <div id="container">
                <h1>Bitcoin Trading Simulator 7.0</h1>
                <div id="scenario-info">
                    <h3 id="scenario-title"></h3>
                    <p id="scenario-desc"></p>
                </div>
                <div id="chart-container">
                    <div id="pl-display" class="chart-overlay-display"></div>
                    <div id="rr-display" class="chart-overlay-display"></div>
                    <svg id="chart-svg"></svg>
                </div>
                <div id="controls">
                     <div class="controls-grid" id="main-controls">
                          <div id="order-type-selector">
                               <button class="order-type-btn active" id="limit-order-btn">Limit Order</button>
                               <button class="order-type-btn" id="market-order-btn">Market Order</button>
                          </div>
                          <button id="long-button">Enter Long</button>
                          <button id="short-button">Enter Short</button>
                     </div>
                     <div class="controls-grid" id="setup-controls" style="display: none;">
                          <button id="confirm-button">Confirm Trade</button>
                          <button id="cancel-button">Cancel</button>
                     </div>
                     <div class="controls-grid" id="running-controls" style="display: none;">
                          <button id="close-button">Close Position Manually</button>
                     </div>
                     <div class="controls-grid" id="reset-controls" style="display: none;">
                          <button id="reset-button">New Scenario</button>
                     </div>
                </div>
                
                <div id="calculator" class="section-box">
                    <div class="calc-grid">
                        <div class="calc-item">
                            <label>Account Balance</label>
                            <span id="balance" class="value"></span>
                        </div>
                        <div class="calc-item">
                            <label for="position-size">Margin (USD)</label>
                            <input type="number" id="position-size" value="1000">
                        </div>
                        <div class="calc-item">
                            <label>Position Size (USD)</label>
                            <span id="total-position-size" class="value"></span>
                        </div>
                        <div class="calc-item">
                            <label>Potential Profit</label>
                            <span id="potential-profit" class="value" style="color: var(--price-green);"></span>
                        </div>
                        <div class="calc-item">
                            <label>Potential Loss</label>
                            <span id="potential-loss" class="value" style="color: var(--price-red);"></span>
                        </div>
                         <div class="calc-item" style="grid-column: 1 / -1;">
                              <label for="leverage-slider">Leverage: <span id="leverage-value">5x</span></label>
                              <input type="range" id="leverage-slider" min="5" max="500" value="5" step="5">
                         </div>
                    </div>
                </div>

                <div id="performance-section" class="section-box" style="display: none;">
                    <h2>Performance</h2>
                    <div id="performance-stats" class="calc-grid">
                        <div class="calc-item"><label>Win Rate</label><span id="win-rate" class="value"></span></div>
                        <div class="calc-item"><label>Total P/L</label><span id="total-pl" class="value"></span></div>
                        <div class="calc-item"><label>Avg. Win</label><span id="avg-win" class="value"></span></div>
                        <div class="calc-item"><label>Avg. Loss</label><span id="avg-loss" class="value"></span></div>
                    </div>
                    <svg id="equity-curve-svg"></svg>
                    <h2>Trade History</h2>
                    <div id="history-log">
                        <table id="history-table">
                            <thead>
                                <tr><th>Scenario</th><th>Side</th><th>Entry</th><th>Exit</th><th>Leverage</th><th>P/L</th></tr>
                            </thead>
                            <tbody id="history-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="result-feedback"></div>
            </div>
        </div>

        <hr>

        <h2>Conclusion & Further Reading</h2>
        <table>
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>What It Is</th>
                    <th>How a Trader Uses It</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Oracle Price</strong></td>
                    <td>The aggregated, true price of an asset from a decentralized oracle.</td>
                    <td>The final, non-negotiable price for settlement (P&L) and liquidations.</td>
                </tr>
                <tr>
                    <td><strong>Open Interest</strong></td>
                    <td>The total value of all open long and short positions.</td>
                    <td>To gauge market conviction. Rising OI + Rising Price = Strong Trend.</td>
                </tr>
                <tr>
                    <td><strong>Skew</strong></td>
                    <td>The imbalance between the value of open long vs. open short positions.</td>
                    <td>To understand which side of the market is more crowded.</td>
                </tr>
                <tr>
                    <td><strong>Funding Rate</strong></td>
                    <td>The fee paid between longs and shorts, determined by the skew.</td>
                    <td>To calculate the cost/yield of holding a position and as a powerful sentiment indicator.</td>
                </tr>
            </tbody>
        </table>
        <p style="text-align:center; margin-top: 2rem;"><em>This guide provides a foundation, but continuous learning and disciplined practice are the keys to long-term success.</em></p>
    </div>

    <script>
        // --- Elements ---
        const svg = document.getElementById('chart-svg');
        const longButton = document.getElementById('long-button');
        const shortButton = document.getElementById('short-button');
        const confirmButton = document.getElementById('confirm-button');
        const cancelButton = document.getElementById('cancel-button');
        const resetButton = document.getElementById('reset-button');
        const closeButton = document.getElementById('close-button');
        const feedbackDiv = document.getElementById('result-feedback');
        const mainControls = document.getElementById('main-controls');
        const setupControls = document.getElementById('setup-controls');
        const runningControls = document.getElementById('running-controls');
        const resetControls = document.getElementById('reset-controls');
        const scenarioTitleEl = document.getElementById('scenario-title');
        const scenarioDescEl = document.getElementById('scenario-desc');
        const plDisplay = document.getElementById('pl-display');
        const rrDisplay = document.getElementById('rr-display');
        const limitOrderBtn = document.getElementById('limit-order-btn');
        const marketOrderBtn = document.getElementById('market-order-btn');
        const balanceEl = document.getElementById('balance');
        const positionSizeInput = document.getElementById('position-size');
        const potentialProfitEl = document.getElementById('potential-profit');
        const potentialLossEl = document.getElementById('potential-loss');
        const leverageSlider = document.getElementById('leverage-slider');
        const leverageValueEl = document.getElementById('leverage-value');
        const performanceSection = document.getElementById('performance-section');
        const winRateEl = document.getElementById('win-rate');
        const totalPlEl = document.getElementById('total-pl');
        const avgWinEl = document.getElementById('avg-win');
        const avgLossEl = document.getElementById('avg-loss');
        const historyTableBody = document.getElementById('history-table-body');
        const equityCurveSvg = document.getElementById('equity-curve-svg');
        const totalPositionSizeEl = document.getElementById('total-position-size');

        // --- State ---
        let candles = [], scenarios = [], tradeHistory = [];
        let simulationInterval;
        let isSimulating = false, tradeSetupMode = false, tradeActive = false;
        let stopLoss = 0, takeProfit = 0, limitPrice = 0, entryPrice = 0, exitPrice = 0;
        let tradeDirection = 0, orderType = 'limit';
        let currentScenario;
        let balance = 10000, margin = 1000, leverage = 5;

        // --- Chart Constants ---
        let svgWidth, svgHeight, candleWidth, maxCandles;
        function updateChartConstants() {
            if (!svg) return;
            svgWidth = svg.clientWidth; svgHeight = svg.clientHeight;
            candleWidth = 5; maxCandles = Math.floor(svgWidth / (candleWidth + 2));
        }

        // --- Price Scale & Drawing ---
        const getPriceRange = () => {
            const prices = candles.flatMap(c => [c.high, c.low]);
            if(stopLoss) prices.push(stopLoss); if(takeProfit) prices.push(takeProfit); if(limitPrice) prices.push(limitPrice);
            const minPrice = Math.min(...prices) * 0.995; const maxPrice = Math.max(...prices) * 1.005;
            return { minPrice, maxPrice };
        };
        const priceToY = (price) => {
            const { minPrice, maxPrice } = getPriceRange();
            if (maxPrice === minPrice) return svgHeight / 2;
            return svgHeight - ((price - minPrice) / (maxPrice - minPrice)) * svgHeight;
        };
        const yToPrice = (y) => {
            const { minPrice, maxPrice } = getPriceRange();
            return ((svgHeight - y) / svgHeight) * (maxPrice - minPrice) + minPrice;
        };
        
        function drawChart() {
            if (!svg) return;
            if (!svgWidth) updateChartConstants();
            svg.innerHTML = ''; if (candles.length === 0) return;
            const { minPrice, maxPrice } = getPriceRange();
            const visibleCandles = candles.slice(-maxCandles);
            
            const priceAxis = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            priceAxis.setAttribute('class', 'price-axis');
            const numGridLines = 6;
            for (let i = 0; i <= numGridLines; i++) {
                const price = minPrice + (i / numGridLines) * (maxPrice - minPrice);
                const y = priceToY(price);
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', 0); line.setAttribute('y1', y); line.setAttribute('x2', svgWidth); line.setAttribute('y2', y);
                line.setAttribute('class', 'grid-line'); svg.appendChild(line);
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', svgWidth - 5); text.setAttribute('y', y - 5); text.setAttribute('text-anchor', 'end');
                text.textContent = price.toFixed(2); priceAxis.appendChild(text);
            }
            svg.appendChild(priceAxis);
            
            visibleCandles.forEach((candle, i) => {
                const x = i * (candleWidth + 2);
                const yOpen = priceToY(candle.open); const yClose = priceToY(candle.close);
                const yHigh = priceToY(candle.high); const yLow = priceToY(candle.low);
                const wick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                wick.setAttribute('x1', x + candleWidth / 2); wick.setAttribute('y1', yHigh); wick.setAttribute('x2', x + candleWidth / 2); wick.setAttribute('y2', yLow);
                wick.setAttribute('class', `wick ${candle.close >= candle.open ? 'up' : 'down'}`); svg.appendChild(wick);
                const body = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                body.setAttribute('x', x); body.setAttribute('y', Math.min(yOpen, yClose)); body.setAttribute('width', candleWidth);
                body.setAttribute('height', Math.abs(yOpen - yClose) || 1); body.setAttribute('class', `candlestick ${candle.close >= candle.open ? 'up' : 'down'}`);
                svg.appendChild(body);
            });
            drawPriceLines();
        }
        
        let draggedElement = null;
        function drawPriceLines() {
            if (!svg) return;
            const drawLine = (id, price, labelPrefix, className) => {
                const y = priceToY(price); let line = document.getElementById(`${id}-line`); let label = document.getElementById(`${id}-label`);
                if (!line) {
                    line = document.createElementNS('http://www.w3.org/2000/svg', 'line'); line.setAttribute('id', `${id}-line`);
                    label = document.createElementNS('http://www.w3.org/2000/svg', 'text'); label.setAttribute('id', `${id}-label`);
                    svg.appendChild(line); svg.appendChild(label);
                    const hitBox = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    hitBox.setAttribute('id', `${id}-hitbox`); hitBox.setAttribute('height', 20); hitBox.setAttribute('width', svgWidth);
                    hitBox.setAttribute('fill', 'transparent'); hitBox.style.cursor = 'ns-resize';
                    hitBox.addEventListener('mousedown', (e) => { if (tradeSetupMode) draggedElement = id; });
                    svg.appendChild(hitBox);
                }
                line.setAttribute('x1', 0); line.setAttribute('y1', y); line.setAttribute('x2', svgWidth); line.setAttribute('y2', y);
                line.className.baseVal = `price-line ${className}`;
                label.setAttribute('x', 5); label.setAttribute('y', y - 5); label.textContent = `${labelPrefix}: ${price.toFixed(2)}`;
                label.className.baseVal = `price-label ${className}`;
                document.getElementById(`${id}-hitbox`).setAttribute('y', y - 10);
            };
            if (stopLoss) drawLine('sl', stopLoss, 'SL', 'sl');
            if (takeProfit) drawLine('tp', takeProfit, 'TP', 'tp');
            if (limitPrice && orderType === 'limit') drawLine('limit', limitPrice, tradeDirection === 1 ? 'Buy Limit' : 'Sell Limit', 'limit');
        }

        if (svg) {
            svg.addEventListener('mousemove', (e) => {
                if (!draggedElement || !tradeSetupMode) return;
                const y = e.clientY - svg.getBoundingClientRect().top;
                const price = parseFloat(yToPrice(y).toFixed(2));
                if (draggedElement === 'sl') stopLoss = price;
                else if (draggedElement === 'tp') takeProfit = price;
                else if (draggedElement === 'limit') limitPrice = price;
                updateTradeMetrics(); drawChart();
            });
        }
        window.addEventListener('mouseup', () => { draggedElement = null; });

        // --- Scenarios & Candle Generation ---
        function setupScenarios() {
            scenarios = [
                { title: "Uptrend Bull Flag", description: "After a strong impulse move up, the price is consolidating sideways. Look for a breakout to the upside." },
                { title: "Range Consolidation", description: "The price is trapped between a clear support and resistance. Look to trade the range or wait for a breakout." },
                { title: "Support Level Bounce", description: "Price has sold off to a key historical support level and is showing signs of bouncing. Look for a long entry." },
                { title: "Resistance Rejection", description: "Price has rallied to a key historical resistance level and is showing signs of weakness. Look for a short entry." },
            ];
        }

        function generateInitialCandles(scenario) {
            candles = [];
            let price = 60000 + (Math.random() - 0.5) * 5000;
            switch (scenario.title) {
                case "Uptrend Bull Flag":
                    for (let i = 0; i < 20; i++) { // Pole
                        const open = price; const change = Math.random() * 150 + 50; price = open + change;
                        candles.push({ open, high: price + Math.random() * 50, low: open - Math.random() * 50, close: price });
                    }
                    let flagHigh = price;
                    for (let i = 0; i < 30; i++) { // Flag
                        const open = price; const change = (Math.random() - 0.55) * 200;
                        price = open + change > flagHigh ? flagHigh - Math.random() * 50 : open + change;
                        candles.push({ open, high: Math.max(open, price) + Math.random() * 100, low: Math.min(open, price) - Math.random() * 100, close: price });
                    }
                    break;
                case "Range Consolidation":
                    let highRange = price + 500, lowRange = price - 500, direction = 1;
                    for (let i = 0; i < 50; i++) {
                        const open = price; const change = (Math.random() * 200) * direction; price = open + change;
                        if (price > highRange) { price = highRange; direction = -1; }
                        if (price < lowRange) { price = lowRange; direction = 1; }
                        candles.push({ open, high: Math.max(open, price) + 50, low: Math.min(open, price) - 50, close: price });
                    }
                    break;
                case "Support Level Bounce":
                    let supportLevel = price - 1000;
                    for (let i = 0; i < 35; i++) { // Downtrend
                        const open = price; const change = (Math.random() * -150) - 20;
                        price = open + change < supportLevel ? supportLevel + Math.random() * 50 : open + change;
                        candles.push({ open, high: open + Math.random() * 50, low: price - Math.random() * 50, close: price });
                    }
                    for (let i = 0; i < 15; i++) { // Bounce
                        const open = price; const change = (Math.random() - 0.4) * 200;
                        price = open + change < supportLevel ? supportLevel : open + change;
                        candles.push({ open, high: Math.max(open, price) + 100, low: Math.min(open, price) - 100, close: price });
                    }
                    break;
                case "Resistance Rejection":
                    let resistanceLevel = price + 1000;
                    for (let i = 0; i < 35; i++) { // Uptrend
                        const open = price; const change = (Math.random() * 150) + 20;
                        price = open + change > resistanceLevel ? resistanceLevel - Math.random() * 50 : open + change;
                        candles.push({ open, high: price + Math.random() * 50, low: open - Math.random() * 50, close: price });
                    }
                    for (let i = 0; i < 15; i++) { // Reject
                        const open = price; const change = (Math.random() - 0.6) * 200;
                        price = open + change > resistanceLevel ? resistanceLevel : open + change;
                        candles.push({ open, high: Math.max(open, price) + 100, low: Math.min(open, price) - 100, close: price });
                    }
                    break;
            }
        }
        
        // --- Simulation Core ---
        function generateNextCandle() {
            const lastClose = candles[candles.length - 1].close;
            const momentum = (lastClose - candles[candles.length - 5].close) / 5;
            const volatility = 800;
            const open = lastClose; const change = (Math.random() - 0.5 + momentum / volatility) * volatility;
            const close = open + change;
            const high = Math.max(open, close) + Math.random() * 200;
            const low = Math.min(open, close) - Math.random() * 200;
            candles.push({ open, high, low, close });
            if(candles.length > maxCandles * 2) candles.shift();
        }

        function runSimulation() {
            isSimulating = true; mainControls.style.display = 'none'; setupControls.style.display = 'none';
            let unfilledCandleCount = 0;
            const limitOrderTimeout = 50;

            if (tradeActive) {
                runningControls.style.display = 'grid';
            }

            simulationInterval = setInterval(() => {
                generateNextCandle();
                const currentHigh = candles[candles.length-1].high;
                const currentLow = candles[candles.length-1].low;
                const currentClose = candles[candles.length-1].close;

                if (!tradeActive) {
                    if (orderType === 'limit') {
                        if ((tradeDirection === 1 && currentLow <= limitPrice) || (tradeDirection === -1 && currentHigh >= limitPrice)) {
                            tradeActive = true; entryPrice = limitPrice; 
                            plDisplay.style.display = 'block';
                            runningControls.style.display = 'grid';
                        } else {
                            unfilledCandleCount++;
                            if (unfilledCandleCount > limitOrderTimeout) {
                                endSimulation('draw', 'Limit order not filled.');
                            }
                        }
                    }
                }
                
                if (tradeActive) {
                    updatePL(currentClose);
                    if (tradeDirection === 1) { // Long
                        if (currentHigh >= takeProfit) { endSimulation('win', `Take Profit hit!`, takeProfit); } 
                        else if (currentLow <= stopLoss) { endSimulation('loss', `Stop Loss hit!`, stopLoss); }
                    } else if (tradeDirection === -1) { // Short
                        if (currentLow <= takeProfit) { endSimulation('win', `Take Profit hit!`, takeProfit); } 
                        else if (currentHigh >= stopLoss) { endSimulation('loss', `Stop Loss hit!`, stopLoss); }
                    }
                }
                
                drawChart();
            }, 200);
        }
        
        // --- Calculation & UI Updates ---
        function updatePositionSizeDisplay() {
            const totalSize = margin * leverage;
            totalPositionSizeEl.textContent = `${totalSize.toLocaleString()}`;
        }

        function updatePL(currentPrice) {
            if (!tradeActive) return 0;
            const effectivePositionSize = margin * leverage;
            const units = effectivePositionSize / entryPrice;
            const pL = (currentPrice - entryPrice) * units * tradeDirection;
            plDisplay.textContent = `P/L: ${pL.toFixed(2)}`;
            plDisplay.style.color = pL >= 0 ? 'var(--price-green)' : 'var(--price-red)';
            return pL;
        }
        
        function updateTradeMetrics() {
            if (!tradeSetupMode) return;
            const entry = (orderType === 'limit') ? limitPrice : candles[candles.length - 1].close;
            const potentialReward = Math.abs(takeProfit - entry);
            const potentialRisk = Math.abs(entry - stopLoss);
            
            if (potentialRisk > 0) {
                const ratio = potentialReward / potentialRisk;
                rrDisplay.textContent = `R/R: ${ratio.toFixed(2)} : 1`;
                if (ratio >= 2) { rrDisplay.className = 'chart-overlay-display rr-good'; } 
                else if (ratio >= 1) { rrDisplay.className = 'chart-overlay-display rr-ok'; } 
                else { rrDisplay.className = 'chart-overlay-display rr-bad'; }
            } else {
                rrDisplay.textContent = 'Invalid R/R'; rrDisplay.className = 'chart-overlay-display rr-bad';
            }
            
            const effectivePositionSize = margin * leverage;
            const units = effectivePositionSize / entry;
            const profitValue = potentialReward * units;
            const lossValue = potentialRisk * units;
            potentialProfitEl.textContent = `${profitValue.toFixed(2)}`;
            potentialLossEl.textContent = `${lossValue.toFixed(2)}`;
        }

        function endSimulation(result, message, finalPrice) {
            if (!isSimulating && result !== 'draw') return; // Prevent multiple calls
            clearInterval(simulationInterval); isSimulating = false; runningControls.style.display = 'none';
            let finalPL = 0; exitPrice = finalPrice;
            if (tradeActive) {
                const effectivePositionSize = margin * leverage;
                const units = effectivePositionSize / entryPrice;
                finalPL = (exitPrice - entryPrice) * units * tradeDirection;
                balance += finalPL;
            }
            
            feedbackDiv.style.display = 'block'; 
            feedbackDiv.className = `result-feedback ${result}`;
            let finalMessage = message;
            if (tradeActive) {
                finalMessage += ` ${finalPL >= 0 ? '+' : ''}${finalPL.toFixed(2)}`;
            }
            feedbackDiv.textContent = finalMessage; 
            resetControls.style.display = 'grid';
            balanceEl.textContent = `${balance.toFixed(2)}`;

            logTrade(result, finalPL);
        }
        
        // --- Performance Tracking ---
        function logTrade(result, pL) {
            if (result === 'draw') return; // Don't log non-trades

            const trade = {
                scenario: currentScenario.title,
                side: tradeDirection === 1 ? 'Long' : 'Short',
                entry: entryPrice.toFixed(2),
                exit: exitPrice.toFixed(2),
                leverage: `${leverage}x`,
                pl: pL,
            };
            tradeHistory.push(trade);
            updatePerformanceStats();
            renderTradeHistory();
            drawEquityCurve();
        }

        function updatePerformanceStats() {
            performanceSection.style.display = 'block';
            const totalTrades = tradeHistory.length;
            const wins = tradeHistory.filter(t => t.pl > 0);
            const losses = tradeHistory.filter(t => t.pl < 0);

            const winRate = totalTrades > 0 ? (wins.length / totalTrades) * 100 : 0;
            winRateEl.textContent = `${winRate.toFixed(1)}%`;

            const totalPL = tradeHistory.reduce((sum, t) => sum + t.pl, 0);
            totalPlEl.textContent = `${totalPL.toFixed(2)}`;
            totalPlEl.style.color = totalPL >= 0 ? 'var(--price-green)' : 'var(--price-red)';

            const avgWin = wins.length > 0 ? wins.reduce((sum, t) => sum + t.pl, 0) / wins.length : 0;
            avgWinEl.textContent = `${avgWin.toFixed(2)}`;
            avgWinEl.style.color = 'var(--price-green)';

            const avgLoss = losses.length > 0 ? losses.reduce((sum, t) => sum + t.pl, 0) / losses.length : 0;
            avgLossEl.textContent = `${avgLoss.toFixed(2)}`;
            avgLossEl.style.color = 'var(--price-red)';
        }

        function renderTradeHistory() {
            historyTableBody.innerHTML = '';
            [...tradeHistory].reverse().forEach(trade => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${trade.scenario}</td>
                    <td>${trade.side}</td>
                    <td>${trade.entry}</td>
                    <td>${trade.exit}</td>
                    <td>${trade.leverage}</td>
                    <td style="color: ${trade.pl >= 0 ? 'var(--price-green)' : 'var(--price-red)'};">${trade.pl.toFixed(2)}</td>
                `;
                historyTableBody.appendChild(row);
            });
        }
        
        function drawEquityCurve() {
            if (!equityCurveSvg) return;
            equityCurveSvg.innerHTML = '';
            if (tradeHistory.length < 2) return;
            
            let equityPoints = [10000];
            tradeHistory.forEach(trade => equityPoints.push(equityPoints[equityPoints.length - 1] + trade.pl));

            const width = equityCurveSvg.clientWidth;
            const height = equityCurveSvg.clientHeight;
            const maxBalance = Math.max(...equityPoints);
            const minBalance = Math.min(...equityPoints, 10000);

            const balanceToY = (val) => height - ((val - minBalance) / (maxBalance - minBalance)) * height;
            const indexToX = (i) => (i / (equityPoints.length - 1)) * width;

            const pathData = equityPoints.map((point, i) => `${i === 0 ? 'M' : 'L'} ${indexToX(i)} ${balanceToY(point)}`).join(' ');
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', pathData);
            path.setAttribute('id', 'equity-curve-path');

            const zeroLineY = balanceToY(10000);
            const zeroLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            zeroLine.setAttribute('x1', 0); zeroLine.setAttribute('y1', zeroLineY);
            zeroLine.setAttribute('x2', width); zeroLine.setAttribute('y2', zeroLineY);
            zeroLine.setAttribute('id', 'equity-curve-zero-line');

            equityCurveSvg.appendChild(zeroLine);
            equityCurveSvg.appendChild(path);
        }

        // --- Event Listeners & Initialization ---
        function enterTradeSetup(direction) {
            tradeSetupMode = true; tradeDirection = direction;
            const lastPrice = candles[candles.length - 1].close;
            if (direction === 1) { // Long
                takeProfit = lastPrice * 1.02; stopLoss = lastPrice * 0.98;
                if (orderType === 'limit') limitPrice = lastPrice * 0.99;
            } else { // Short
                takeProfit = lastPrice * 0.98; stopLoss = lastPrice * 1.02;
                if (orderType === 'limit') limitPrice = lastPrice * 1.01;
            }
            mainControls.style.display = 'none'; setupControls.style.display = 'grid';
            rrDisplay.style.display = 'block'; updateTradeMetrics(); drawChart();
        }

        function cancelTradeSetup() {
            tradeSetupMode = false;
            stopLoss = 0; takeProfit = 0; limitPrice = 0; tradeDirection = 0;
            mainControls.style.display = 'grid'; setupControls.style.display = 'none';
            rrDisplay.style.display = 'none';
            potentialProfitEl.textContent = ''; potentialLossEl.textContent = '';
            drawChart();
        }

        function confirmTrade() {
            const lastPrice = candles[candles.length - 1].close;
            const showError = (message) => {
                feedbackDiv.textContent = message;
                feedbackDiv.className = 'result-feedback loss';
                feedbackDiv.style.display = 'block';
                setTimeout(() => {
                    if (!isSimulating) feedbackDiv.style.display = 'none';
                }, 3000);
            };

            if (orderType === 'limit') {
                 if (tradeDirection === 1 && (limitPrice > lastPrice || takeProfit < limitPrice || stopLoss > limitPrice)) {
                    showError("For a LONG LIMIT, your limit price must be below the current price, TP above limit, and SL below limit."); return;
                }
                 if (tradeDirection === -1 && (limitPrice < lastPrice || takeProfit > limitPrice || stopLoss < limitPrice)) {
                    showError("For a SHORT LIMIT, your limit price must be above the current price, TP below limit, and SL above limit."); return;
                }
            } else { // Market Order
                 if (tradeDirection === 1 && (takeProfit < lastPrice || stopLoss > lastPrice)) {
                    showError("For a LONG MARKET, TP must be above current price, and SL must be below."); return;
                 }
                 if (tradeDirection === -1 && (takeProfit > lastPrice || stopLoss < lastPrice)) {
                    showError("For a SHORT MARKET, TP must be below current price, and SL must be above."); return;
                 }
                tradeActive = true; entryPrice = lastPrice;
                plDisplay.style.display = 'block'; updatePL(lastPrice);
            }
            tradeSetupMode = false; rrDisplay.style.display = 'none';
            feedbackDiv.style.display = 'none'; // Hide error if trade is valid
            runSimulation();
        }

        function initialize() {
            // Check if simulator elements exist before running
            if (!document.getElementById('trading-simulator-app')) return;

            updateChartConstants(); setupScenarios();
            currentScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            scenarioTitleEl.textContent = currentScenario.title;
            scenarioDescEl.textContent = currentScenario.description;
            generateInitialCandles(currentScenario);
            isSimulating = false; tradeSetupMode = false; tradeActive = false;
            stopLoss = 0; takeProfit = 0; limitPrice = 0; entryPrice = 0; tradeDirection = 0;
            if (simulationInterval) clearInterval(simulationInterval);
            mainControls.style.display = 'grid'; setupControls.style.display = 'none';
            runningControls.style.display = 'none'; resetControls.style.display = 'none'; 
            feedbackDiv.style.display = 'none';
            plDisplay.style.display = 'none'; rrDisplay.style.display = 'none';
            balanceEl.textContent = `${balance.toFixed(2)}`;
            margin = parseInt(positionSizeInput.value);
            leverage = parseInt(leverageSlider.value);
            updatePositionSizeDisplay();
            potentialProfitEl.textContent = ''; potentialLossEl.textContent = '';
            drawChart();
        }
        
        if (limitOrderBtn) {
            limitOrderBtn.addEventListener('click', () => {
                orderType = 'limit'; limitOrderBtn.classList.add('active'); marketOrderBtn.classList.remove('active');
            });
        }
        if (marketOrderBtn) {
            marketOrderBtn.addEventListener('click', () => {
                orderType = 'market'; marketOrderBtn.classList.add('active'); limitOrderBtn.classList.remove('active');
            });
        }
        if (positionSizeInput) {
            positionSizeInput.addEventListener('change', () => {
                margin = parseInt(positionSizeInput.value) || 0;
                updatePositionSizeDisplay();
                if(tradeSetupMode) updateTradeMetrics();
            });
        }
        if (leverageSlider) {
            leverageSlider.addEventListener('input', () => {
                leverage = parseInt(leverageSlider.value);
                leverageValueEl.textContent = `${leverage}x`;
                updatePositionSizeDisplay();
                 if(tradeSetupMode) updateTradeMetrics();
            });
        }
        
        if (longButton) longButton.addEventListener('click', () => enterTradeSetup(1));
        if (shortButton) shortButton.addEventListener('click', () => enterTradeSetup(-1));
        if (cancelButton) cancelButton.addEventListener('click', cancelTradeSetup);
        if (confirmButton) confirmButton.addEventListener('click', confirmTrade);
        if (resetButton) resetButton.addEventListener('click', initialize);
        if (closeButton) {
            closeButton.addEventListener('click', () => {
                if (isSimulating && tradeActive) {
                    const closePrice = candles[candles.length - 1].close;
                    const result = updatePL(closePrice) >= 0 ? 'win' : 'loss';
                    endSimulation(result, 'Position closed manually', closePrice);
                }
            });
        }

        window.onload = initialize;
        window.onresize = () => { updateChartConstants(); drawChart(); };

    </script>
</body>
</html>
